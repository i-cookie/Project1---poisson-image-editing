# Project1 Poisson Image Editing

### 理论学习

根据原论文，泊松图像编辑是用于无缝克隆等操作的一种简单且效果显著的方式。目标是要做到边缘无缝拼接，并且尽量保留源图片内部的纹理。因此思路便有了：在源图像在背景图像克隆的区域 $\Omega$ ，将其边缘一圈 $\partial \Omega$ 的像素值直接赋值为背景图，然后再根据源图像的相邻像素值的变化量来推导克隆后的$\Omega$内部是多少。而纹理的变化事实上反映在源图像的梯度场中。

根据原论文的结论，我们对每个像素都可以列出一个线性方程：
$$
\forall p\in\Omega,\ |N_p|f_p-\sum_{q\in N_p\cap\Omega}f_q=\sum_{q\in N_p\cap\partial\Omega}f^*_q+\sum_{q\in N_p}v_{pq} \\
v_{pq}=g_p-g_q
$$
其中$f_p$表示当前像素，$|N_p|$表示当前像素有多少个相邻像素在背景图范围内，$f_q$表示其中一个相邻像素的值，$f_q^*$表示背景图中某相邻像素位置上的像素值，$v_{pq}$表示源图片在当前像素的梯度向量在 $pq$ 向量上的投影,$g$表示源图片的像素值。

这样一来，方程左边是未知量，右边是已知量，对每个像素都列出这样一个方程后，我们可以发现方程数=未知量数，于是我们可以解这个线性方程组，最终得到所有的$f$值。

因为每个方程左边最多只有五个未知量，因此我们将使用稀疏矩阵来节省空间。

### 具体实施

此project使用Python编写，使用Numpy和openCV库处理图像，并使用Scipy库进行方程组求解。在截取与克隆图像方面，此project使用openCV编写GUI，支持任意形状的ROI，并可以可视化地选择克隆的位置。

<img src=".\Components\ROI.png" alt="ROI"  /><img src=".\mask.png" alt="mask" style="zoom:150%;" /><img src=".\Components\paste.png" alt="image-20230701135236129" style="zoom:50%;" />

最终得到的结果如下：

![result](.\result.png)

起初运行时，图片的较暗处和较亮处（即明暗交界处）会发生明显的色彩错误，暗处会变为几乎白色，亮处会变为几乎黑色，因此经过输出方程的解发现是解得的像素值略低于0或略高于255，导致像素值溢出。长时间调试无果后，我发现溢出量并不大，对图片的最终质量起不到决定性效果，于是使用`Numpy.clip()`将解限制在0到255之间，最终获得了以上效果，基本令人满意。

### 心得体会

与一年前相比，我最大的变化是不再依赖于手把手的教学了。一年前面对这个项目时，我还认为需要连同各种数学和编程知识全部从底层开始学会才能真正完成这个项目，因此面对未知的巨大工作量和深入知识望洋兴叹。但是一年来，我认识到做一个项目并不需要在底层了解其全部，而只需要对特定工具的掌握，对问题的拆解以及多使用搜索引擎辅助自己。同时修读了CSC4140 计算机图形学课程以后我也对图形学有了基本的了解，对复杂的项目也能冷静对待，不容易心态爆炸，可以说此时面对这个项目我的心态已经发生了大转变。我对泊松图像编辑的了解并不比一年前多，但是通过分析深入，我却能逐渐攻克一年前束手无策的难题，心里感到十分快乐。

目前此项目已上传至github [Project1---poisson-image-editing](https://github.com/i-cookie/Project1---poisson-image-editing)

